# VolaBot Development Makefile
# Convenient command interface for N8N workflow development

# Project files
MAIN_PROMPT := MAIN_PROMPT.md
WORKFLOW_JSON := Hotels-Agent-CRISTI.json
SCRIPTS_DIR := scripts
BACKUP_DIR := archive/backups

# Default target
.DEFAULT_GOAL := help

.PHONY: help sync validate dev update-from-downloads integrate backup deploy organize update-limits-to-% update-charge-to-% clean setup test status update-limits update-charge-limits truncate

## Show this help message
help:
	@echo "ğŸ¤– VolaBot Development Commands"
	@echo "=============================="
	@echo ""
	@echo "âš¡ Core Development:"
	@echo "  ğŸ”„ sync      - Enhanced sync: create template + full workflow"
	@echo "  âœ… validate  - Validate workflow structure"
	@echo "  ğŸš€ dev       - Quick development cycle (sync + validate)"
	@echo "  ğŸ”„ update-from-downloads - Sync workflow from N8N GUI export"
	@echo "  ğŸ¯ integrate - Import GUI changes + sync prompts + validate"
	@echo ""
	@echo "ğŸ“¦ Workflow Generation:"
	@echo "  âœ‚ï¸ strip     - Create clean template (empty prompts, for git)"
	@echo "  ğŸ“¤ export    - Generate full workflow (with prompts, for N8N)"
	@echo "  ğŸ¯ import-ready - Prepare workflow for N8N import"
	@echo ""
	@echo "ğŸš¢ Deployment:"
	@echo "  ğŸ’¾ backup    - Create timestamped backup"
	@echo "  ğŸ¯ deploy    - Full preparation for deployment"
	@echo ""
	@echo "ğŸ“ Project Management:"
	@echo "  ğŸ“¦ organize  - Organize test data files"
	@echo "  ğŸ› ï¸ setup     - Initial project setup"
	@echo "  ğŸ§¹ clean     - Clean up temporary files"
	@echo ""
	@echo "ğŸ§ª Testing & Info:"
	@echo "  ğŸ” test      - Run validation and basic checks"
	@echo "  ğŸ“Š status    - Show project status"
	@echo "  â“ help      - Show this help message"
	@echo ""
	@echo "ğŸ”§ API Configuration:"
	@echo "  âš™ï¸ update-limits        - Update API limits (interactive)"
	@echo "  âš™ï¸ update-limits-to-X   - Set API limits to X (e.g., make update-limits-to-10)"
	@echo "  ğŸ’° update-charge-limits - Update API charge limits (interactive)"
	@echo "  ğŸ’° update-charge-to-X   - Set charge limits to $X (e.g., make update-charge-to-2.50)"
	@echo ""
	@echo "ğŸ“ Data Processing:"
	@echo "  âœ‚ï¸ truncate             - Truncate JSON file (usage: make truncate FILE=path.json LIMIT=5)"
	@echo ""
	@echo "â­ Quick Start:"
	@echo "  1. Edit $(MAIN_PROMPT) or IMAGE_PROMPT.md"
	@echo "  2. Run: make dev"
	@echo "  3. Import $(WORKFLOW_JSON).full to N8N"
	@echo ""

## Enhanced sync: Create both stripped template and full workflow with prompts
sync:
	@echo "ğŸ”„ Enhanced sync: processing both prompt files..."
	@if [ ! -f "$(MAIN_PROMPT)" ]; then \
		echo "âŒ $(MAIN_PROMPT) not found!"; \
		exit 1; \
	fi
	@if [ ! -f "IMAGE_PROMPT.md" ]; then \
		echo "âŒ IMAGE_PROMPT.md not found!"; \
		exit 1; \
	fi
	@node $(SCRIPTS_DIR)/sync-prompt.js
	@echo "âœ… Enhanced sync completed"

## Create stripped template (empty prompts, for git commits)
strip:
	@echo "ğŸ”„ Creating stripped template for git..."
	@node $(SCRIPTS_DIR)/sync-prompt.js
	@echo "âœ… Stripped template ready for git"

## Create full workflow for N8N import (alias for sync)
export: sync
	@echo "ğŸ“¦ Full workflow ready for N8N import: $(WORKFLOW_JSON).full"

## Alias for export with clear intent
import-ready: export
	@echo "ğŸ¯ Workflow prepared for N8N GUI import"

## Validate workflow structure and configuration
validate:
	@echo "ğŸ” Validating workflow..."
	@if [ ! -f "$(WORKFLOW_JSON)" ]; then \
		echo "âŒ $(WORKFLOW_JSON) not found!"; \
		exit 1; \
	fi
	@node $(SCRIPTS_DIR)/validate-workflow.js
	@echo "âœ… Validation completed"

## Quick development cycle: sync + validate
dev: sync validate
	@echo "âœ… Development cycle complete!"
	@echo ""
	@echo "ğŸ“‹ Next steps:"
	@echo "1. Import $(WORKFLOW_JSON).full into N8N"
	@echo "2. Test the workflow in N8N interface"
	@echo "3. Commit only .md files and template .json to git"

## Sync workflow from N8N GUI export in Downloads
update-from-downloads:
	@echo "ğŸ”„ Looking for $(WORKFLOW_JSON) in Downloads..."
	@DOWNLOAD_FILE=$$(find ~/Downloads -name "$(WORKFLOW_JSON)" -type f -mtime -2 -name "*.json" 2>/dev/null | head -1); \
	if [ -z "$$DOWNLOAD_FILE" ]; then \
		echo "âŒ No recent $(WORKFLOW_JSON) found in Downloads (last 2 days)"; \
		exit 1; \
	fi; \
	echo "ğŸ“ Found: $$DOWNLOAD_FILE"; \
	if [ ! -f "$(WORKFLOW_JSON)" ] || [ "$$DOWNLOAD_FILE" -nt "$(WORKFLOW_JSON)" ]; then \
		echo "ğŸ’¾ Creating backup before update..."; \
		mkdir -p $(BACKUP_DIR); \
		TIMESTAMP=$$(date +%Y%m%d-%H%M%S); \
		if [ -f "$(WORKFLOW_JSON)" ]; then \
			mv "$(WORKFLOW_JSON)" "$(BACKUP_DIR)/Hotels-Agent-CRISTI-backup-$$TIMESTAMP.json"; \
			echo "âœ… Backup created: Hotels-Agent-CRISTI-backup-$$TIMESTAMP.json"; \
		fi; \
		mv "$$DOWNLOAD_FILE" "$(WORKFLOW_JSON)"; \
		echo "âœ… Updated $(WORKFLOW_JSON) from Downloads"; \
		echo "ğŸ“‹ Next steps:"; \
		echo "1. Run: make validate"; \
		echo "2. Test the updated workflow"; \
	else \
		echo "âš ï¸ Downloads file is not newer than current file - no update needed"; \
	fi

## Full integration: import GUI changes, sync prompts, validate
integrate: update-from-downloads sync validate
	@echo "ğŸ¯ Full integration complete!"
	@echo ""
	@echo "âœ… What just happened:"
	@echo "  1. Imported N8N GUI changes (with backup created)"
	@echo "  2. Synced your latest .md prompts to the workflow"  
	@echo "  3. Validated the integrated workflow"
	@echo ""
	@echo "ğŸ“¦ Ready to import: Hotels-Agent-CRISTI.full.json"
	@echo "ğŸ”„ Your GUI changes + prompt updates are now combined!"

## Create timestamped backup of workflow JSON
backup:
	@echo "ğŸ’¾ Creating backup..."
	@mkdir -p $(BACKUP_DIR)
	@TIMESTAMP=$$(date +%Y%m%d-%H%M%S); \
	cp $(WORKFLOW_JSON) $(BACKUP_DIR)/Hotels-Agent-CRISTI-backup-$$TIMESTAMP.json && \
	echo "âœ… Backup created: Hotels-Agent-CRISTI-backup-$$TIMESTAMP.json"

## Full preparation for deployment
deploy: backup sync validate
	@echo "âœ… Ready for N8N deployment!"
	@echo ""
	@echo "ğŸš¢ Deployment Steps:"
	@echo "1. Access Railway N8N instance"
	@echo "2. Import $(WORKFLOW_JSON)"
	@echo "3. Configure credentials if needed"
	@echo "4. Test the workflow"
	@echo ""
	@echo "ğŸ”„ Rollback available in: $(BACKUP_DIR)/"

## Organize scattered test data files
organize:
	@echo "ğŸ“ Organizing test data..."
	@node $(SCRIPTS_DIR)/organize-test-data.js
	@echo "âœ… Organization completed"

## Clean up temporary files and caches
clean:
	@echo "ğŸ§¹ Cleaning up..."
	@rm -rf node_modules/.cache 2>/dev/null || true
	@rm -f *.log 2>/dev/null || true
	@rm -f .DS_Store 2>/dev/null || true
	@find . -name "*.tmp" -delete 2>/dev/null || true
	@echo "âœ… Cleanup completed"

## Initial project setup
setup:
	@echo "ğŸš€ Setting up VolaBot project..."
	@echo "ğŸ“¦ Installing dependencies..."
	@npm install
	@echo "ğŸ“ Organizing test data..."
	@node $(SCRIPTS_DIR)/organize-test-data.js
	@echo "ğŸ”„ Syncing prompt..."
	@node $(SCRIPTS_DIR)/sync-prompt.js
	@echo "âœ… Validating workflow..."
	@node $(SCRIPTS_DIR)/validate-workflow.js
	@echo "âœ… Setup completed!"
	@echo ""
	@echo "ğŸ‰ Project ready! Next steps:"
	@echo "1. Configure N8N credentials"
	@echo "2. Import $(WORKFLOW_JSON) to N8N"
	@echo "3. Run: make help for available commands"

## Run validation and basic checks
test: validate
	@echo "ğŸ§ª Running additional tests..."
	@echo "ğŸ“ Checking file structure..."
	@[ -f "$(MAIN_PROMPT)" ] && echo "âœ… $(MAIN_PROMPT) exists" || (echo "âŒ $(MAIN_PROMPT) missing" && exit 1)
	@[ -f "$(WORKFLOW_JSON)" ] && echo "âœ… $(WORKFLOW_JSON) exists" || (echo "âŒ $(WORKFLOW_JSON) missing" && exit 1)
	@[ -d "$(SCRIPTS_DIR)" ] && echo "âœ… Scripts directory exists" || (echo "âŒ Scripts directory missing" && exit 1)
	@echo "ğŸ”§ Checking script permissions..."
	@[ -x "$(SCRIPTS_DIR)/sync-prompt.js" ] || chmod +x $(SCRIPTS_DIR)/sync-prompt.js
	@[ -x "$(SCRIPTS_DIR)/validate-workflow.js" ] || chmod +x $(SCRIPTS_DIR)/validate-workflow.js
	@[ -x "$(SCRIPTS_DIR)/organize-test-data.js" ] || chmod +x $(SCRIPTS_DIR)/organize-test-data.js
	@echo "âœ… Script permissions OK"
	@echo "âš™ï¸ Checking JSON syntax..."
	@node -e "JSON.parse(require('fs').readFileSync('$(WORKFLOW_JSON)'))" && echo "âœ… JSON syntax valid" || (echo "âŒ JSON syntax invalid" && exit 1)
	@echo "âœ… All tests passed!"

## Show project status and info
status:
	@echo "ğŸ“Š VolaBot Project Status"
	@echo "====================="
	@echo ""
	@echo "ğŸ“„ Files:"
	@if [ -f "$(MAIN_PROMPT)" ]; then \
		PROMPT_SIZE=$$(wc -c < "$(MAIN_PROMPT)" | tr -d ' '); \
		PROMPT_LINES=$$(wc -l < "$(MAIN_PROMPT)" | tr -d ' '); \
		echo "  ğŸ“ $(MAIN_PROMPT): $$PROMPT_SIZE chars, $$PROMPT_LINES lines"; \
	else \
		echo "  âŒ $(MAIN_PROMPT): Missing"; \
	fi
	@if [ -f "$(WORKFLOW_JSON)" ]; then \
		JSON_SIZE=$$(wc -c < "$(WORKFLOW_JSON)" | tr -d ' '); \
		NODE_COUNT=$$(node -e "console.log(JSON.parse(require('fs').readFileSync('$(WORKFLOW_JSON)')).nodes.length)" 2>/dev/null || echo "?"); \
		echo "  ğŸ”§ $(WORKFLOW_JSON): $$JSON_SIZE chars, $$NODE_COUNT nodes"; \
	else \
		echo "  âŒ $(WORKFLOW_JSON): Missing"; \
	fi
	@echo ""
	@echo "$(YELLOW)Directory Structure:$(RESET)"
	@[ -d "scripts" ] && echo "  âœ… scripts/" || echo "  âŒ scripts/"
	@[ -d "config" ] && echo "  âœ… config/" || echo "  âŒ config/"
	@[ -d "test-data" ] && echo "  âœ… test-data/" || echo "  âŒ test-data/"
	@[ -d "docs" ] && echo "  âœ… docs/" || echo "  âŒ docs/"
	@[ -d "archive" ] && echo "  âœ… archive/" || echo "  âŒ archive/"
	@echo ""
	@echo "$(YELLOW)Backups:$(RESET)"
	@if [ -d "$(BACKUP_DIR)" ] && [ "$$(ls -A $(BACKUP_DIR) 2>/dev/null)" ]; then \
		BACKUP_COUNT=$$(ls -1 $(BACKUP_DIR)/*.json 2>/dev/null | wc -l | tr -d ' '); \
		LATEST_BACKUP=$$(ls -t $(BACKUP_DIR)/*.json 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "None"); \
		echo "  ğŸ’¾ $$BACKUP_COUNT backups available"; \
		echo "  ğŸ“… Latest: $$LATEST_BACKUP"; \
	else \
		echo "  âš ï¸ No backups found"; \
	fi
	@echo ""
	@echo "$(YELLOW)Quick Actions:$(RESET)"
	@echo "  $(GREEN)make dev$(RESET)     - Sync and validate"
	@echo "  $(GREEN)make deploy$(RESET)  - Prepare for deployment"
	@echo "  $(GREEN)make help$(RESET)    - Show all commands"

# Advanced targets for power users

## Check for outdated backups (older than 30 days)
clean-backups:
	@echo "$(YELLOW)ğŸ§¹ Cleaning old backups (>30 days)...$(RESET)"
	@if [ -d "$(BACKUP_DIR)" ]; then \
		find $(BACKUP_DIR) -name "*.json" -type f -mtime +30 -delete 2>/dev/null && \
		echo "$(GREEN)âœ… Old backups cleaned$(RESET)" || \
		echo "$(BLUE)â„¹ï¸ No old backups to clean$(RESET)"; \
	else \
		echo "$(BLUE)â„¹ï¸ No backup directory found$(RESET)"; \
	fi

## Show diff between current and last backup
diff:
	@echo "$(YELLOW)ğŸ“Š Comparing with latest backup...$(RESET)"
	@if [ -d "$(BACKUP_DIR)" ] && [ "$$(ls -A $(BACKUP_DIR) 2>/dev/null)" ]; then \
		LATEST_BACKUP=$$(ls -t $(BACKUP_DIR)/*.json 2>/dev/null | head -1); \
		if [ -f "$$LATEST_BACKUP" ]; then \
			echo "$(BLUE)Comparing $(WORKFLOW_JSON) with $$(basename $$LATEST_BACKUP)$(RESET)"; \
			diff "$$LATEST_BACKUP" "$(WORKFLOW_JSON)" || echo "$(GREEN)Files are identical$(RESET)"; \
		else \
			echo "$(RED)âŒ No backup file found$(RESET)"; \
		fi \
	else \
		echo "$(RED)âŒ No backups available for comparison$(RESET)"; \
	fi

## Show prompt statistics
prompt-stats:
	@echo "$(BLUE)ğŸ“Š MAIN_PROMPT.md Statistics$(RESET)"
	@echo "============================="
	@if [ -f "$(MAIN_PROMPT)" ]; then \
		echo "Characters: $$(wc -c < $(MAIN_PROMPT))"; \
		echo "Lines: $$(wc -l < $(MAIN_PROMPT))"; \
		echo "Words: $$(wc -w < $(MAIN_PROMPT))"; \
		echo ""; \
		echo "$(YELLOW)Key Sections:$(RESET)"; \
		grep -c "##" $(MAIN_PROMPT) | awk '{print "  Main sections: " $$1}'; \
		grep -c "###" $(MAIN_PROMPT) | awk '{print "  Subsections: " $$1}'; \
		grep -c "VolaBot" $(MAIN_PROMPT) | awk '{print "  VolaBot mentions: " $$1}'; \
	else \
		echo "$(RED)âŒ $(MAIN_PROMPT) not found$(RESET)"; \
	fi

## Update API limits in workflow (interactive)
update-limits:
	@echo "ğŸ”§ Updating API limits in workflow..."
	@python3 $(SCRIPTS_DIR)/update-api-limits.py

## Update API limits with specific value (pattern rule)
update-limits-to-%:
	@echo "ğŸ¯ Setting API limits to $*..."
	@python3 $(SCRIPTS_DIR)/update-api-limits.py $*

## Update API charge limits in workflow (interactive)
update-charge-limits:
	@echo "ğŸ’° Updating API charge limits in workflow..."
	@python3 $(SCRIPTS_DIR)/update-charge-limits.py

## Update API charge limits with specific value (pattern rule)
update-charge-to-%:
	@echo "ğŸ’° Setting API charge limits to $$$*..."
	@python3 $(SCRIPTS_DIR)/update-charge-limits.py $*

## Truncate JSON file to specified number of elements
truncate:
	@if [ -z "$(FILE)" ] || [ -z "$(LIMIT)" ]; then \
		echo "âŒ Usage: make truncate FILE=path/to/file.json LIMIT=5"; \
		echo "ğŸ“ Example: make truncate FILE=apify/booking-scraper/dataset.json LIMIT=10"; \
		exit 1; \
	fi
	@echo "âœ‚ï¸ Truncating JSON file to $(LIMIT) elements..."
	@python3 $(SCRIPTS_DIR)/truncate-json.py "$(FILE)" "$(LIMIT)"

# Hidden targets (not shown in help)
.PHONY: clean-backups diff prompt-stats